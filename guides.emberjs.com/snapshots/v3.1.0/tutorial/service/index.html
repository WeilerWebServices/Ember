<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#e46652">

    <title>Ember.js - Tutorial: Services and Utilities</title>
    <meta property="st:title" content="Tutorial: Services and Utilities" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="../../images/favicon.png" rel="icon" type="image/png" />
    <!--[if lte IE 7 ]><link href="../../stylesheets/fonts/fontello-ie7.css" rel="stylesheet" /><![endif]-->
    <link href="../../stylesheets/application.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    
    <!-- This TypeKit account is managed by @wifelette. Contact her with any issues. -->
    <script src="https://use.typekit.net/stz3kpn.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>

    <link href="/blog/feed.xml" rel="alternate" type="application/atom+xml" title="Ember.js - Blog" />
    
  </head>

  <body class="guides tutorial tutorial_service tutorial_service_index">

    <!--[if lt IE 9]>
      <script src="../../javascripts/common-old-ie.js"></script>
    <![endif]-->
    <!--[if gte IE 9]><!-->
      <script src="../../javascripts/common-modern.js"></script>
    <!--<![endif]-->

    <header>
<nav class="navbar navbar-inverse">
 <div class="container">
  <div class="navbar-header">
   <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
   <a class="navbar-brand" href="http://emberjs.com"><img src="https://glimmer-styleguide.global.ssl.fastly.net/glimmer-styleguide/master/images/ember-logo.svg" alt="home" /></a>
  </div>
  <div class="collapse navbar-collapse" id="navbar-collapse">
   <ul class="nav navbar-nav">
    <li class="dropdown">
     <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Docs <span class="caret"></span></a>
     <ul class="dropdown-menu">
      <li><a href="http://emberjs.com/guides">Guides</a></li>
      <li><a href="http://emberjs.com/api">API Reference</a></li>
      <li role="separator" class="divider"></li>
      <li><a href="http://emberjs.com/learn">Learn Ember</a></li>
     </ul>
    </li>
    <li class="dropdown">
     <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Releases <span class="caret"></span></a>
     <ul class="dropdown-menu">
      <li><a href="http://emberjs.com/builds">Channels</a></li>
      <li><a href="http://emberjs.com/builds/release">-- Stable</a></li>
      <li><a href="http://emberjs.com/builds/beta">-- Beta</a></li>
      <li><a href="http://emberjs.com/builds/canary">-- Canary</a></li>
      <li role="separator" class="divider"></li>
      <li><a href="http://emberjs.com/deprecations">Deprecations</a></li>
      <li><a href="http://emberjs.com/statusboard">Status Board</a></li>
     </ul>
    </li>
    <li><a href="http://emberjs.com/blog">Blog</a></li>
    <li class="dropdown">
     <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Community <span class="caret"></span></a>
     <ul class="dropdown-menu">
      <li><a href="http://emberjs.com/community">The Ember Community</a></li>
       <li><a href="http://emberjs.com/guidelines">Guidelines</a></li>
       <li><a href="http://github.com/emberjs/">Contribute (Github)</a></li>
       <li role="separator" class="divider"></li>
       <li><a href="http://emberjs.com/community/meetups">Meetups</a></li>
       <li><a href="http://jobs.emberjs.com/">Job Board</a></li>
       <li role="separator" class="divider"></li>
       <li><a href="http://emberconf.com/">Ember Conf</a></li>
     </ul>
     </li>
     <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">About<span class="caret"></span></a>
      <ul class="dropdown-menu">
       <li><a href="http://emberjs.com/team">The Team</a></li>
       <li role="separator" class="divider"></li>
       <li><a href="http://emberjs.com/logos">Logos</a></li>
       <li><a href="http://emberjs.com/mascots">Mascots</a></li>
       <li role="separator" class="divider"></li>
       <li><a href="http://emberjs.com/ember-users">Who Uses Ember</a></li>
       <li><a href="http://emberjs.com/sponsors">Sponsors</a></li>
       <li role="separator" class="divider"></li>
       <li><a href="http://emberjs.com/legal">Legal</a></li>
       <li><a href="http://emberjs.com/security">Security</a></li>
      </ul>
     </li>
   </ul>
   <form class="navbar-form navbar-right searchbox">
    <div class="input-group">
      <label for="search-input" class="control-label sr-only">Search</label>
        <input type="text"
        class="form-control search input ds-input"
        placeholder="Search..."
        id="search-input"
        role="combobox"
        aria-expanded="false"
        aria-owns="algolia-autocomplete-listbox-0"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
        />
        <span></span>
    </div>
   </form>
  </div>
  <!-- /.navbar-collapse -->
 </div>
 <!-- /.container-fluid -->
</nav>
</header>


    

    <main class="container">

      <aside class="sidebar">
  <label for="version-select" class="visually-hidden">Guides version</label>
  <select class="version-select" id="version-select" style="width: 100%"></select>

  <input id="toc-toggle" class="toc-toggle visually-hidden" type="checkbox" />
  <label for="toc-toggle">Table of Contents <span class="visually-hidden">toggle</span></label>

  <nav class='toc-container' aria-label='table of contents'><ol class='toc-level-0 selected'><li class='toc-level-0 '><a href="#">Getting Started</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../getting-started/quick-start/">Quick Start</a></li><li class='toc-level-1 '><a href="../../getting-started/">Installing Ember</a></li><li class='toc-level-1 '><a href="../../getting-started/core-concepts/">Core Concepts</a></li><li class='toc-level-1 '><a href="../../getting-started/js-primer/">JavaScript Primer</a></li></ol></li><li class='toc-level-0 selected'><a href="#">Tutorial</a><ol class='toc-level-1 selected'><li class='toc-level-1 '><a href="../ember-cli/">Creating Your App</a></li><li class='toc-level-1 '><a href="../acceptance-test/">Planning Your App</a></li><li class='toc-level-1 '><a href="../routes-and-templates/">Routes and Templates</a></li><li class='toc-level-1 '><a href="../model-hook/">The Model Hook</a></li><li class='toc-level-1 '><a href="../installing-addons/">Installing Addons</a></li><li class='toc-level-1 '><a href="../simple-component/">Building a Simple Component</a></li><li class='toc-level-1 '><a href="../hbs-helper/">Creating a Handlebars Helper</a></li><li class='toc-level-1 '><a href="../ember-data/">Using Ember Data</a></li><li class='toc-level-1 '><a href="../autocomplete-component/">Building a Complex Component</a></li><li class='toc-level-1 selected'><a href="./">Services and Utilities</a></li><li class='toc-level-1 '><a href="../subroutes/">Adding Nested Routes</a></li><li class='toc-level-1 '><a href="../deploying/">Deploying</a></li></ol></li><li class='toc-level-0 '><a href="#">The Object Model</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../object-model/">Objects in Ember</a></li><li class='toc-level-1 '><a href="../../object-model/classes-and-instances/">Classes and Instances</a></li><li class='toc-level-1 '><a href="../../object-model/reopening-classes-and-instances/">Reopening Classes and Instances</a></li><li class='toc-level-1 '><a href="../../object-model/computed-properties/">Computed Properties</a></li><li class='toc-level-1 '><a href="../../object-model/computed-properties-and-aggregate-data/">Computed Properties and Aggregate Data</a></li><li class='toc-level-1 '><a href="../../object-model/observers/">Observers</a></li><li class='toc-level-1 '><a href="../../object-model/bindings/">Bindings</a></li><li class='toc-level-1 '><a href="../../object-model/enumerables/">Enumerables</a></li></ol></li><li class='toc-level-0 '><a href="#">Routing</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../routing/">Introduction</a></li><li class='toc-level-1 '><a href="../../routing/defining-your-routes/">Defining Your Routes</a></li><li class='toc-level-1 '><a href="../../routing/specifying-a-routes-model/">Specifying a Route's Model</a></li><li class='toc-level-1 '><a href="../../routing/rendering-a-template/">Rendering a Template</a></li><li class='toc-level-1 '><a href="../../routing/redirection/">Redirecting</a></li><li class='toc-level-1 '><a href="../../routing/preventing-and-retrying-transitions/">Preventing and Retrying Transitions</a></li><li class='toc-level-1 '><a href="../../routing/loading-and-error-substates/">Loading / Error Substates</a></li><li class='toc-level-1 '><a href="../../routing/query-params/">Query Parameters</a></li><li class='toc-level-1 '><a href="../../routing/asynchronous-routing/">Asynchronous Routing</a></li></ol></li><li class='toc-level-0 '><a href="#">Templates</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../templates/handlebars-basics/">Handlebars Basics</a></li><li class='toc-level-1 '><a href="../../templates/built-in-helpers/">Built-in Helpers</a></li><li class='toc-level-1 '><a href="../../templates/conditionals/">Conditionals</a></li><li class='toc-level-1 '><a href="../../templates/displaying-a-list-of-items/">Displaying a List of Items</a></li><li class='toc-level-1 '><a href="../../templates/displaying-the-keys-in-an-object/">Displaying the Keys in an Object</a></li><li class='toc-level-1 '><a href="../../templates/binding-element-attributes/">Binding Element Attributes</a></li><li class='toc-level-1 '><a href="../../templates/links/">Links</a></li><li class='toc-level-1 '><a href="../../templates/actions/">Actions</a></li><li class='toc-level-1 '><a href="../../templates/input-helpers/">Input Helpers</a></li><li class='toc-level-1 '><a href="../../templates/development-helpers/">Development Helpers</a></li><li class='toc-level-1 '><a href="../../templates/writing-helpers/">Writing Helpers</a></li></ol></li><li class='toc-level-0 '><a href="#">Components</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../components/defining-a-component/">Defining a Component</a></li><li class='toc-level-1 '><a href="../../components/the-component-lifecycle/">The Component Lifecycle</a></li><li class='toc-level-1 '><a href="../../components/passing-properties-to-a-component/">Passing Properties to a Component</a></li><li class='toc-level-1 '><a href="../../components/wrapping-content-in-a-component/">Wrapping Content in a Component</a></li><li class='toc-level-1 '><a href="../../components/customizing-a-components-element/">Customizing a Component's Element</a></li><li class='toc-level-1 '><a href="../../components/block-params/">Using Block Params</a></li><li class='toc-level-1 '><a href="../../components/handling-events/">Handling Events</a></li><li class='toc-level-1 '><a href="../../components/triggering-changes-with-actions/">Triggering Changes with Actions</a></li></ol></li><li class='toc-level-0 '><a href="#">Controllers</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../controllers/">Introduction</a></li></ol></li><li class='toc-level-0 '><a href="#">Models</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../models/">Introduction</a></li><li class='toc-level-1 '><a href="../../models/defining-models/">Defining Models</a></li><li class='toc-level-1 '><a href="../../models/finding-records/">Finding Records</a></li><li class='toc-level-1 '><a href="../../models/creating-updating-and-deleting-records/">Creating, Updating and Deleting</a></li><li class='toc-level-1 '><a href="../../models/relationships/">Relationships</a></li><li class='toc-level-1 '><a href="../../models/pushing-records-into-the-store/">Pushing Records into the Store</a></li><li class='toc-level-1 '><a href="../../models/handling-metadata/">Handling Metadata</a></li><li class='toc-level-1 '><a href="../../models/customizing-adapters/">Customizing Adapters</a></li><li class='toc-level-1 '><a href="../../models/customizing-serializers/">Customizing Serializers</a></li></ol></li><li class='toc-level-0 '><a href="#">Application Concerns</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../applications/applications-and-instances/">Applications and Instances</a></li><li class='toc-level-1 '><a href="../../applications/dependency-injection/">Dependency Injection</a></li><li class='toc-level-1 '><a href="../../applications/initializers/">Initializers</a></li><li class='toc-level-1 '><a href="../../applications/services/">Services</a></li><li class='toc-level-1 '><a href="../../applications/run-loop/">The Run Loop</a></li></ol></li><li class='toc-level-0 '><a href="#">Testing</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../testing/">Introduction</a></li><li class='toc-level-1 '><a href="../../testing/acceptance/">Application Tests</a></li><li class='toc-level-1 '><a href="../../testing/unit-testing-basics/">Testing Basics</a></li><li class='toc-level-1 '><a href="../../testing/testing-components/">Testing Components</a></li><li class='toc-level-1 '><a href="../../testing/testing-helpers/">Testing Helpers</a></li><li class='toc-level-1 '><a href="../../testing/testing-controllers/">Testing Controllers</a></li><li class='toc-level-1 '><a href="../../testing/testing-routes/">Testing Routes</a></li><li class='toc-level-1 '><a href="../../testing/testing-models/">Testing Models</a></li></ol></li><li class='toc-level-0 '><a href="#">Ember Inspector</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../ember-inspector/">Introduction</a></li><li class='toc-level-1 '><a href="../../ember-inspector/installation/">Installing the Inspector</a></li><li class='toc-level-1 '><a href="../../ember-inspector/object-inspector/">Object Inspector</a></li><li class='toc-level-1 '><a href="../../ember-inspector/view-tree/">The View Tree</a></li><li class='toc-level-1 '><a href="../../ember-inspector/routes/">Inspecting Routes</a></li><li class='toc-level-1 '><a href="../../ember-inspector/data/">Data Tab</a></li><li class='toc-level-1 '><a href="../../ember-inspector/deprecations/">Tackling Deprecations</a></li><li class='toc-level-1 '><a href="../../ember-inspector/info/">Library Info</a></li><li class='toc-level-1 '><a href="../../ember-inspector/promises/">Debugging Promises</a></li><li class='toc-level-1 '><a href="../../ember-inspector/container/">Inspecting Objects via the Container</a></li><li class='toc-level-1 '><a href="../../ember-inspector/render-performance/">Rendering Performance</a></li><li class='toc-level-1 '><a href="../../ember-inspector/troubleshooting/">Troubleshooting</a></li></ol></li><li class='toc-level-0 '><a href="#">Addons and Dependencies</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../addons-and-dependencies/managing-dependencies/">Managing Dependencies</a></li></ol></li><li class='toc-level-0 '><a href="#">Configuring Ember.js</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../configuring-ember/configuring-your-app/">Configuring Your App</a></li><li class='toc-level-1 '><a href="../../configuring-ember/configuring-ember-cli/">Configuring Ember CLI</a></li><li class='toc-level-1 '><a href="../../configuring-ember/handling-deprecations/">Handling Deprecations</a></li><li class='toc-level-1 '><a href="../../configuring-ember/disabling-prototype-extensions/">Disabling Prototype Extensions</a></li><li class='toc-level-1 '><a href="../../configuring-ember/specifying-url-type/">Specifying the URL Type</a></li><li class='toc-level-1 '><a href="../../configuring-ember/embedding-applications/">Embedding Applications</a></li><li class='toc-level-1 '><a href="../../configuring-ember/feature-flags/">Feature Flags</a></li><li class='toc-level-1 '><a href="../../configuring-ember/build-targets/">Build targets</a></li><li class='toc-level-1 '><a href="../../configuring-ember/debugging/">Debugging</a></li></ol></li><li class='toc-level-0 '><a href="#">Contributing to Ember.js</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../contributing/adding-new-features/">Adding New Features</a></li><li class='toc-level-1 '><a href="../../contributing/repositories/">Repositories</a></li></ol></li><li class='toc-level-0 '><a href="#">Glossary</a><ol class='toc-level-1'><li class='toc-level-1 '><a href="../../glossary/web-development/">Web Development</a></li></ol></li></ol></nav>

  <a href="#" class="back-to-top">&#11014; Back to Top</a>
</aside>


      <article class="chapter">
        <h1>
          Services and Utilities
          <a href="https://github.com/emberjs/guides/edit/master/source/tutorial/service.md"
             target="_blank" class="edit-page icon-pencil">Edit Page</a>
        </h1>
        <hr>

        <p>For Super Rentals, we want to be able to display a map showing where each rental is.
To implement this feature, we will take advantage of several Ember concepts:</p>

<ol>
<li>A utility function to create a map from the Google Maps API.</li>
<li>A service to keep a cache of rendered maps to use in different places in the application.</li>
<li>A component to display a map on each rental listing.</li>
</ol>
<h3 class='anchorable-toc' id='toc_making-google-maps-available'>Making Google Maps Available</h3>
<p>Before implementing a map, we need to make a 3rd party map API available to our Ember app.
There are several ways to include 3rd party libraries in Ember.
See the guides section on <a href="../../addons-and-dependencies/managing-dependencies/">managing dependencies</a>
as a starting point when you need to add one.</p>

<p>The <a href="https://developers.google.com/maps/documentation/javascript/tutorial">Google Maps API</a> requires us to reference its library from a remote script.
In this case we&#39;ll provide this script to our Ember app via an Addon called <code>ember-simple-google-maps</code>.</p>
<div class="highlight shell "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>ember install ember-simple-google-maps
</pre></td>
</tr></table>
</div></div>
<p>Google Maps requires an API key for deployment.
You can <a href="https://developers.google.com/maps/documentation/javascript/get-api-key">Generate an API key</a>
from Google.
Add your new API key to the application by stopping the server and restarting it with the environment variable, <code>GOOGLE_MAPS_API_KEY</code>.</p>
<div class="highlight shell "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>GOOGLE_MAPS_API_KEY=&lt;your key here&gt; ember s
</pre></td>
</tr></table>
</div></div><h3 class='anchorable-toc' id='toc_accessing-the-google-maps-api-with-a-utility'>Accessing the Google Maps API with a Utility</h3>
<p>Ember utilities are reusable code that can be accessed from various parts of the application.
For Super Rentals, we&#39;ll use a utility to access the Google Maps API.
The utility will abstract the Google API away from our Maps service,
which will allow for future reuse of the maps API within the application,
easier refactoring to alternate maps implementations,
and easier testing of code that depends on it.</p>

<p>Now that we have the maps API available to the application, we can create our map utility.
Utility files can be generated using Ember CLI.</p>
<div class="highlight shell "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>ember g util google-maps
</pre></td>
</tr></table>
</div></div>
<p>The CLI <code>generate util</code> command will create a utility file and a unit test.
We&#39;ll delete the unit test since we don&#39;t want to test Google code.</p>

<p>Our app needs a single function, <code>createMap</code>,
which makes use of <code>google.maps.Map</code> to create our map element,
<code>google.maps.Geocoder</code> to lookup the coordinates of our location,
and <code>google.maps.Marker</code> to pin our map based on the resolved location.</p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><?xml version="1.0"?>
<table class="CodeRay">
  <thead>
    <tr>
      <td colspan="2">app/utils/google-maps.js</td>
    </tr>
  </thead>
<tr>
  <td class="line-numbers"><pre><span class="highlight-line removed">1</span>
<span class="highlight-line removed">2</span>
<span class="highlight-line removed">3</span>
<span class="highlight-line added">4</span>
5
<span class="highlight-line added">6</span>
7
<span class="highlight-line added">8</span>
9
<span class="highlight-line added"><strong>10</strong></span>
<span class="highlight-line added">11</span>
<span class="highlight-line added">12</span>
13
<span class="highlight-line added">14</span>
<span class="highlight-line added">15</span>
<span class="highlight-line added">16</span>
<span class="highlight-line added">17</span>
<span class="highlight-line added">18</span>
19
<span class="highlight-line added"><strong>20</strong></span>
<span class="highlight-line added">21</span>
<span class="highlight-line added">22</span>
<span class="highlight-line added">23</span>
<span class="highlight-line added">24</span>
<span class="highlight-line added">25</span>
<span class="highlight-line added">26</span>
<span class="highlight-line added">27</span>
<span class="highlight-line added">28</span>
<span class="highlight-line added">29</span>
<strong>30</strong>
<span class="highlight-line added">31</span></pre></td>
  <td class="code"><pre><span class="highlight-line removed"><span class="reserved">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="function">googleMaps</span>() {</span>
<span class="highlight-line removed">  <span class="keyword">return</span> <span class="predefined-constant">true</span>;</span>
<span class="highlight-line removed">}</span>
<span class="highlight-line added"><span class="reserved">import</span> EmberObject from <span class="string"><span class="delimiter">'</span><span class="content">@ember/object</span><span class="delimiter">'</span></span>;</span>

<span class="highlight-line added">const google = window.google;</span>

<span class="highlight-line added"><span class="reserved">export</span> <span class="keyword">default</span> EmberObject.extend({</span>

<span class="highlight-line added">  init() {</span>
<span class="highlight-line added">    <span class="local-variable">this</span>.set(<span class="string"><span class="delimiter">'</span><span class="content">geocoder</span><span class="delimiter">'</span></span>, <span class="keyword">new</span> window.google.maps.Geocoder());</span>
<span class="highlight-line added">  },</span>

<span class="highlight-line added">  createMap(element, location) {</span>
<span class="highlight-line added">    let map = <span class="keyword">new</span> google.maps.Map(element, { <span class="key">scrollwheel</span>: <span class="predefined-constant">false</span>, <span class="key">zoom</span>: <span class="integer">10</span> });</span>
<span class="highlight-line added">    <span class="local-variable">this</span>.pinLocation(location, map);</span>
<span class="highlight-line added">    <span class="keyword">return</span> map;</span>
<span class="highlight-line added">  },</span>

<span class="highlight-line added">  pinLocation(location, map) {</span>
<span class="highlight-line added">    <span class="local-variable">this</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">geocoder</span><span class="delimiter">'</span></span>).geocode({<span class="key">address</span>: location}, (result, status) =&gt; {</span>
<span class="highlight-line added">      <span class="keyword">if</span> (status === google.maps.GeocoderStatus.OK) {</span>
<span class="highlight-line added">        let geometry = result[<span class="integer">0</span>].geometry.location;</span>
<span class="highlight-line added">        let position = { <span class="key">lat</span>: geometry.lat(), <span class="key">lng</span>: geometry.lng() };</span>
<span class="highlight-line added">        map.setCenter(position);</span>
<span class="highlight-line added">        <span class="keyword">new</span> google.maps.Marker({ position, map, <span class="key">title</span>: location });</span>
<span class="highlight-line added">      }</span>
<span class="highlight-line added">    });</span>
<span class="highlight-line added">  }</span>

<span class="highlight-line added">});</span></pre></td>
</tr></table>
</div></div><h3 class='anchorable-toc' id='toc_fetching-maps-with-a-service'>Fetching Maps With a Service</h3>
<p>Now that we are able to generate a map element,
we will implement a maps service that will keep a reference to the Map object we create,
and attach the map to an element in our application</p>

<p>Accessing our maps API through a <a href="../../applications/services">service</a> will give us several benefits</p>

<ul>
<li>It is injected with a <a href="https://en.wikipedia.org/wiki/Service_locator_pattern">service locator</a>,
meaning it will abstract the maps API from the code that uses it,
allowing for easier refactoring and maintenance.</li>
<li>It is lazy-loaded, meaning it won&#39;t be initialized until it is called the first time.
In some cases this can reduce your app&#39;s processor load and memory consumption.</li>
<li>It is a singleton, which means there is only one instance of the service object in the browser.
This will allow us to keep map data while the user navigates around the app,
so that returning to a page doesn&#39;t require it to reload its maps.</li>
</ul>

<p>Let&#39;s get started creating our service by generating it through Ember CLI,
which will create the service file, as well as a unit test for it.</p>
<div class="highlight shell "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>ember g service maps
</pre></td>
</tr></table>
</div></div>
<p>Now implement the service as follows.
Note that we check if a map already exists for the given location and use that one,
otherwise we call a Google Maps utility to create one.</p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><?xml version="1.0"?>
<table class="CodeRay">
  <thead>
    <tr>
      <td colspan="2">app/services/maps.js</td>
    </tr>
  </thead>
<tr>
  <td class="line-numbers"><pre>1
<span class="highlight-line added">2</span>
<span class="highlight-line added">3</span>
4
<span class="highlight-line added">5</span>
6
7
8
<span class="highlight-line added">9</span>
<span class="highlight-line added"><strong>10</strong></span>
<span class="highlight-line added">11</span>
<span class="highlight-line added">12</span>
<span class="highlight-line added">13</span>
<span class="highlight-line added">14</span>
<span class="highlight-line added">15</span>
<span class="highlight-line added">16</span>
<span class="highlight-line added">17</span>
18
<span class="highlight-line added">19</span>
<span class="highlight-line added"><strong>20</strong></span>
<span class="highlight-line added">21</span>
<span class="highlight-line added">22</span>
<span class="highlight-line added">23</span>
<span class="highlight-line added">24</span>
<span class="highlight-line added">25</span>
<span class="highlight-line added">26</span>
<span class="highlight-line added">27</span>
<span class="highlight-line added">28</span>
29
<span class="highlight-line added"><strong>30</strong></span>
<span class="highlight-line added">31</span>
<span class="highlight-line added">32</span>
<span class="highlight-line added">33</span>
<span class="highlight-line added">34</span>
35
36</pre></td>
  <td class="code"><pre><span class="reserved">import</span> Service from <span class="string"><span class="delimiter">'</span><span class="content">@ember/service</span><span class="delimiter">'</span></span>;
<span class="highlight-line added"><span class="reserved">import</span> { camelize } from <span class="string"><span class="delimiter">'</span><span class="content">@ember/string</span><span class="delimiter">'</span></span>;</span>
<span class="highlight-line added"><span class="reserved">import</span> EmberObject from <span class="string"><span class="delimiter">'</span><span class="content">@ember/object</span><span class="delimiter">'</span></span>;</span>

<span class="highlight-line added"><span class="reserved">import</span> MapUtil from <span class="string"><span class="delimiter">'</span><span class="content">../utils/google-maps</span><span class="delimiter">'</span></span>;</span>

<span class="reserved">export</span> <span class="keyword">default</span> Service.extend({

<span class="highlight-line added">  init() {</span>
<span class="highlight-line added">    <span class="local-variable">this</span>._super(...<span class="local-variable">arguments</span>);</span>
<span class="highlight-line added">    <span class="keyword">if</span> (!<span class="local-variable">this</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">cachedMaps</span><span class="delimiter">'</span></span>)) {</span>
<span class="highlight-line added">      <span class="local-variable">this</span>.set(<span class="string"><span class="delimiter">'</span><span class="content">cachedMaps</span><span class="delimiter">'</span></span>, EmberObject.create());</span>
<span class="highlight-line added">    }</span>
<span class="highlight-line added">    <span class="keyword">if</span> (!<span class="local-variable">this</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">mapUtil</span><span class="delimiter">'</span></span>)) {</span>
<span class="highlight-line added">      <span class="local-variable">this</span>.set(<span class="string"><span class="delimiter">'</span><span class="content">mapUtil</span><span class="delimiter">'</span></span>, MapUtil.create());</span>
<span class="highlight-line added">    }</span>
<span class="highlight-line added">  },</span>

<span class="highlight-line added">  getMapElement(location) {</span>
<span class="highlight-line added">    let camelizedLocation = camelize(location);</span>
<span class="highlight-line added">    let element = <span class="local-variable">this</span>.get(<span class="error">`</span>cachedMaps.<span class="predefined">$</span>{camelizedLocation}<span class="error">`</span>);</span>
<span class="highlight-line added">    <span class="keyword">if</span> (!element) {</span>
<span class="highlight-line added">      element = <span class="local-variable">this</span>.createMapElement();</span>
<span class="highlight-line added">      <span class="local-variable">this</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">mapUtil</span><span class="delimiter">'</span></span>).createMap(element, location);</span>
<span class="highlight-line added">      <span class="local-variable">this</span>.set(<span class="error">`</span>cachedMaps.<span class="predefined">$</span>{camelizedLocation}<span class="error">`</span>, element);</span>
<span class="highlight-line added">    }</span>
<span class="highlight-line added">    <span class="keyword">return</span> element;</span>
<span class="highlight-line added">  },</span>

<span class="highlight-line added">  createMapElement() {</span>
<span class="highlight-line added">    let element = document.createElement(<span class="string"><span class="delimiter">'</span><span class="content">div</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">    element.className = <span class="string"><span class="delimiter">'</span><span class="content">map</span><span class="delimiter">'</span></span>;</span>
<span class="highlight-line added">    <span class="keyword">return</span> element;</span>
<span class="highlight-line added">  }</span>

});</pre></td>
</tr></table>
</div></div><h3 class='anchorable-toc' id='toc_display-maps-with-a-component'>Display Maps With a Component</h3>
<p>With a service and utility that render a map to a web page element,
we&#39;ll connect it to our application using a component.</p>

<p>Generate the map component using Ember CLI.</p>
<div class="highlight shell "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>ember g component location-map
</pre></td>
</tr></table>
</div></div>
<p>Running this command generates three files: a component JavaScript file, a template, and a test file.</p>

<p>Let&#39;s start by adding a <code>div</code> element to the component template.
This <code>div</code> will act as a place for the 3rd party map API to render the map to.</p>
<div class="highlight handlebars "><div class="ribbon"></div><div class="scroller"><?xml version="1.0"?>
<table class="CodeRay">
  <thead>
    <tr>
      <td colspan="2">app/templates/components/location-map.hbs</td>
    </tr>
  </thead>
<tr>
  <td class="line-numbers"><pre><span class="highlight-line removed">1</span>
<span class="highlight-line added">2</span></pre></td>
  <td class="code"><pre><span class="highlight-line removed"><span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">yield</span><span class="inline-delimiter">}}</span></span></span>
<span class="highlight-line added"><span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">map-container</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/div&gt;</span></span></pre></td>
</tr></table>
</div></div>
<p>Next, update the component to append the map output to the <code>div</code> element we created.</p>

<p>We provide the maps service into our component by initializing a property of our component, called <code>maps</code>.
Services are commonly made available in components and other Ember objects by <a href="../../applications/services/#toc_accessing-services">&quot;service injection&quot;</a>.
When you initialize a property with <code>import { inject } from &#39;@ember/service&#39;;</code>,
Ember tries to set that property with a service matching its name.</p>

<p>With our <code>maps</code> service, our component will call the <code>getMapElement</code> function with the provided location.
We append the map element we get back from the service by implementing <code>didInsertElement</code>,
which is a <a href="../../components/the-component-lifecycle/#toc_integrating-with-third-party-libraries-with-code-didinsertelement-code">component lifecycle hook</a>.
This function runs during the component render, after the component&#39;s markup gets inserted into the page.</p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><?xml version="1.0"?>
<table class="CodeRay">
  <thead>
    <tr>
      <td colspan="2">app/components/location-map.js</td>
    </tr>
  </thead>
<tr>
  <td class="line-numbers"><pre>1
<span class="highlight-line added">2</span>
3
4
<span class="highlight-line added">5</span>
6
<span class="highlight-line added">7</span>
<span class="highlight-line added">8</span>
<span class="highlight-line added">9</span>
<span class="highlight-line added"><strong>10</strong></span>
<span class="highlight-line added">11</span>
<span class="highlight-line added">12</span>
13</pre></td>
  <td class="code"><pre><span class="reserved">import</span> Component from <span class="string"><span class="delimiter">'</span><span class="content">@ember/component</span><span class="delimiter">'</span></span>;
<span class="highlight-line added"><span class="reserved">import</span> { inject as service } from <span class="string"><span class="delimiter">'</span><span class="content">@ember/service</span><span class="delimiter">'</span></span>;</span>

<span class="reserved">export</span> <span class="keyword">default</span> Component.extend({
<span class="highlight-line added">  <span class="key">maps</span>: service(),</span>

<span class="highlight-line added">  didInsertElement() {</span>
<span class="highlight-line added">    <span class="local-variable">this</span>._super(...<span class="local-variable">arguments</span>);</span>
<span class="highlight-line added">    let location = <span class="local-variable">this</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">location</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">    let mapElement = <span class="local-variable">this</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">maps</span><span class="delimiter">'</span></span>).getMapElement(location);</span>
<span class="highlight-line added">    <span class="local-variable">this</span>.<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.map-container</span><span class="delimiter">'</span></span>).append(mapElement);</span>
<span class="highlight-line added">  }</span>
});</pre></td>
</tr></table>
</div></div>
<p>You may have noticed that <code>this.get(&#39;location&#39;)</code> refers to a property location we haven&#39;t defined.
This property will be passed in to the component by its parent template below.</p>

<p>Finally open the template file for our <code>rental-listing</code> component and add the new <code>location-map</code> component.</p>
<div class="highlight handlebars "><div class="ribbon"></div><div class="scroller"><?xml version="1.0"?>
<table class="CodeRay">
  <thead>
    <tr>
      <td colspan="2">app/templates/components/rental-listing.hbs</td>
    </tr>
  </thead>
<tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<span class="highlight-line added"><strong>20</strong></span>
21</pre></td>
  <td class="code"><pre><span class="tag">&lt;article</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">listing</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;a</span> <span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">action</span> <span class="error">'</span><span class="attribute-name">toggleImageSize</span><span class="error">'</span><span class="inline-delimiter">}}</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">image </span></span><span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">if</span> <span class="attribute-name">isWide</span> <span class="error">"</span><span class="attribute-name">wide</span><span class="error">"</span><span class="inline-delimiter">}}</span></span><span class="string"><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;img</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span></span><span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">rental.image</span><span class="inline-delimiter">}}</span></span><span class="string"><span class="delimiter">"</span></span> <span class="attribute-name">alt</span>=<span class="string"><span class="delimiter">"</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;small&gt;</span>View Larger<span class="tag">&lt;/small&gt;</span>
  <span class="tag">&lt;/a&gt;</span>
  <span class="tag">&lt;h3&gt;</span><span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">rental.title</span><span class="inline-delimiter">}}</span></span><span class="tag">&lt;/h3&gt;</span>
  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">detail owner</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;span&gt;</span>Owner:<span class="tag">&lt;/span&gt;</span> <span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">rental.owner</span><span class="inline-delimiter">}}</span></span>
  <span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">detail type</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;span&gt;</span>Type:<span class="tag">&lt;/span&gt;</span> <span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">rental-property-type</span> <span class="attribute-name">rental.category</span><span class="inline-delimiter">}}</span></span>
      - <span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">rental.category</span><span class="inline-delimiter">}}</span></span>
  <span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">detail location</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;span&gt;</span>Location:<span class="tag">&lt;/span&gt;</span> <span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">rental.city</span><span class="inline-delimiter">}}</span></span>
  <span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">detail bedrooms</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;span&gt;</span>Number of bedrooms:<span class="tag">&lt;/span&gt;</span> <span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">rental.bedrooms</span><span class="inline-delimiter">}}</span></span>
  <span class="tag">&lt;/div&gt;</span>
<span class="highlight-line added">  <span class="inline"><span class="inline-delimiter">{{</span><span class="attribute-name">location-map</span> <span class="attribute-name">location</span>=<span class="attribute-value">rental.city</span><span class="inline-delimiter">}}</span></span></span>
<span class="tag">&lt;/article&gt;</span></pre></td>
</tr></table>
</div></div>
<p>After starting the server we should now see some end to end maps functionality show up on our front page!</p>

<p><img src="../../images/service/style-super-rentals-maps.png" alt="super rentals homepage with maps"></p>

<p>You may now either move onto the <a href="../subroutes/">next feature</a>, or continue here to test the maps feature we just added.</p>
<h3 class='anchorable-toc' id='toc_unit-testing-a-service'>Unit testing a Service</h3>
<p>We&#39;ll use a unit test to validate the service.
Unit tests are more isolated than integration tests and application tests,
and are intended for testing specific logic within a class.</p>

<p>For our service unit test, we&#39;ll want to verify that locations that have been previously loaded are fetched from cache, while new locations are created using the utility.
We will isolate our tests from actually calling Google Maps by stubbing our map utility.
On line 6 of <code>maps-test.js</code> below we create an Ember object to simulate the behavior of the utility, but instead of creating a google map, we return an empty JavaScript object.</p>

<p>To instantiate the service, we can instantiate it through ember&#39;s resolver using the <a href="https://emberjs.com/api/ember/release/classes/ApplicationInstance/methods/factoryFor?anchor=factoryFor"><code>factoryFor</code></a> method.
<code>factoryFor</code> allows us to have control over the creation of the service in Ember, to pass arguments to the constructor that can override parts of the service for our tests.</p>

<p>For cases where we do not need to override parts of the service, we can use <a href="https://emberjs.com/api/ember/release/classes/ApplicationInstance/methods/lookup?anchor=lookup"><code>lookup</code></a>
In our test below we are passing in our fake map utility object in the first test, and passing a cache object for the second test.</p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><?xml version="1.0"?>
<table class="CodeRay">
  <thead>
    <tr>
      <td colspan="2">tests/unit/services/maps-test.js</td>
    </tr>
  </thead>
<tr>
  <td class="line-numbers"><pre>1
2
3
<span class="highlight-line added">4</span>
<span class="highlight-line added">5</span>
6
<span class="highlight-line removed">7</span>
<span class="highlight-line added">8</span>
9
<span class="highlight-line added"><strong>10</strong></span>
<span class="highlight-line removed">11</span>
<span class="highlight-line removed">12</span>
<span class="highlight-line removed">13</span>
<span class="highlight-line removed">14</span>
<span class="highlight-line removed">15</span>
<span class="highlight-line removed">16</span>
<span class="highlight-line added">17</span>
<span class="highlight-line added">18</span>
<span class="highlight-line added">19</span>
<span class="highlight-line added"><strong>20</strong></span>
<span class="highlight-line added">21</span>
<span class="highlight-line added">22</span>
<span class="highlight-line added">23</span>
<span class="highlight-line added">24</span>
<span class="highlight-line added">25</span>
<span class="highlight-line added">26</span>
<span class="highlight-line added">27</span>
<span class="highlight-line added">28</span>
<span class="highlight-line added">29</span>
<span class="highlight-line added"><strong>30</strong></span>
<span class="highlight-line added">31</span>
<span class="highlight-line added">32</span>
<span class="highlight-line added">33</span>
<span class="highlight-line added">34</span>
<span class="highlight-line added">35</span>
<span class="highlight-line added">36</span>
<span class="highlight-line added">37</span>
<span class="highlight-line added">38</span>
<span class="highlight-line added">39</span>
<span class="highlight-line added"><strong>40</strong></span>
<span class="highlight-line added">41</span>
42</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { module, test } from <span class="string"><span class="delimiter">'</span><span class="content">qunit</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { setupTest } from <span class="string"><span class="delimiter">'</span><span class="content">ember-qunit</span><span class="delimiter">'</span></span>;

<span class="highlight-line added"/>
<span class="highlight-line added">const DUMMY_ELEMENT = {};</span>

<span class="highlight-line removed">module(<span class="string"><span class="delimiter">'</span><span class="content">Unit | Service | maps</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(hooks) {</span>
<span class="highlight-line added">module(<span class="string"><span class="delimiter">'</span><span class="content">service:maps</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Unit | Service | maps</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> (hooks) {</span>
  setupTest(hooks);
<span class="highlight-line added"/>
<span class="highlight-line removed">  <span class="comment">// Replace this with your real tests.</span></span>
<span class="highlight-line removed">  test(<span class="string"><span class="delimiter">'</span><span class="content">it exists</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(assert) {</span>
<span class="highlight-line removed">    let service = <span class="local-variable">this</span>.owner.lookup(<span class="string"><span class="delimiter">'</span><span class="content">service:maps</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line removed">    assert.ok(service);</span>
<span class="highlight-line removed">  });</span>
<span class="highlight-line removed"/>
<span class="highlight-line added">  test(<span class="string"><span class="delimiter">'</span><span class="content">should create a new map if one isnt cached for location</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> (assert) {</span>
<span class="highlight-line added">    assert.expect(<span class="integer">4</span>);</span>
<span class="highlight-line added">    let stubMapUtil = {</span>
<span class="highlight-line added">      createMap(element, location) {</span>
<span class="highlight-line added">        assert.ok(element, <span class="string"><span class="delimiter">'</span><span class="content">createMap called with element</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">        assert.ok(location, <span class="string"><span class="delimiter">'</span><span class="content">createMap called with location</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">        <span class="keyword">return</span> DUMMY_ELEMENT;</span>
<span class="highlight-line added">      }</span>
<span class="highlight-line added">    };</span>
<span class="highlight-line added">    let mapService = <span class="local-variable">this</span>.owner.factoryFor(<span class="string"><span class="delimiter">'</span><span class="content">service:maps</span><span class="delimiter">'</span></span>).create({ <span class="key">mapUtil</span>: stubMapUtil });</span>
<span class="highlight-line added">    let element = mapService.getMapElement(<span class="string"><span class="delimiter">'</span><span class="content">San Francisco</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">    assert.ok(element, <span class="string"><span class="delimiter">'</span><span class="content">element exists</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">    assert.equal(element.className, <span class="string"><span class="delimiter">'</span><span class="content">map</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">element has class name of map</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">  });</span>
<span class="highlight-line added"/>
<span class="highlight-line added">  test(<span class="string"><span class="delimiter">'</span><span class="content">should use existing map if one is cached for location</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> (assert) {</span>
<span class="highlight-line added">    assert.expect(<span class="integer">1</span>);</span>
<span class="highlight-line added">    let stubCachedMaps = {</span>
<span class="highlight-line added">      <span class="key">sanFrancisco</span>: DUMMY_ELEMENT</span>
<span class="highlight-line added">    };</span>
<span class="highlight-line added">    let mapService = <span class="local-variable">this</span>.owner.factoryFor(<span class="string"><span class="delimiter">'</span><span class="content">service:maps</span><span class="delimiter">'</span></span>).create({ <span class="key">cachedMaps</span>: stubCachedMaps });</span>
<span class="highlight-line added">    let element = mapService.getMapElement(<span class="string"><span class="delimiter">'</span><span class="content">San Francisco</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">    assert.equal(element, DUMMY_ELEMENT, <span class="string"><span class="delimiter">'</span><span class="content">element fetched from cache</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">  });</span>
<span class="highlight-line added"/>
})</pre></td>
</tr></table>
</div></div>
<p>When the service calls <code>createMap</code> on our fake utility <code>stubMapUtil</code>, we will run asserts to validate that it is called.
In our first test notice that we expect four asserts to be run in line 18. Two of the asserts run in the test function, while the other two are run when <code>createMap</code> is called.</p>

<p>In the second test, only one assert is expected (line 33), since the map element is fetched from cache and does not use the utility.</p>

<p>Also, note that the second test uses a dummy object as the returned map element (defined on line 5).
Our map element can be substituted with any object because we are only asserting that the cache has been accessed (see line 39).</p>

<p>The location in the cache has been <a href="https://www.emberjs.com/api/ember/release/classes/String/methods/camelize?anchor=camelize"><code>camelized</code></a> (line 30),
so that it may be used as a key to look up our element.
This matches the behavior in <code>getMapElement</code> when city has not yet been cached.</p>
<h3 class='anchorable-toc' id='toc_integration-testing-the-map-component'>Integration Testing the Map Component</h3>
<p>Now let&#39;s test that the map component is relying on our service to provide map elements.</p>

<p>To limit the test to validating only its own behavior and not the service, we&#39;ll take advantage of the registration API to register a stub maps service.
That way when Ember injects the map service into the component, it uses our fake service instead of the real one.</p>

<p>A stub stands in place of the real object in your application and simulates its behavior.
In the stub service, define a method that will fetch the map based on location, called <code>getMapElement</code>.</p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><?xml version="1.0"?>
<table class="CodeRay">
  <thead>
    <tr>
      <td colspan="2">tests/integration/components/location-map-test.js</td>
    </tr>
  </thead>
<tr>
  <td class="line-numbers"><pre><span class="highlight-line added">1</span>
2
3
4
5
6
<span class="highlight-line added">7</span>
<span class="highlight-line added">8</span>
<span class="highlight-line added">9</span>
<span class="highlight-line added"><strong>10</strong></span>
<span class="highlight-line added">11</span>
<span class="highlight-line added">12</span>
<span class="highlight-line added">13</span>
<span class="highlight-line added">14</span>
15
16
17
18
<span class="highlight-line added">19</span>
<span class="highlight-line added"><strong>20</strong></span>
<span class="highlight-line added">21</span>
<span class="highlight-line added">22</span>
23
<span class="highlight-line added">24</span>
<span class="highlight-line added">25</span>
<span class="highlight-line added">26</span>
<span class="highlight-line added">27</span>
<span class="highlight-line added">28</span>
<span class="highlight-line added">29</span>
<strong>30</strong>
<span class="highlight-line removed">31</span>
<span class="highlight-line removed">32</span>
<span class="highlight-line removed">33</span>
<span class="highlight-line removed">34</span>
<span class="highlight-line removed">35</span>
<span class="highlight-line removed">36</span>
<span class="highlight-line removed">37</span>
<span class="highlight-line removed">38</span>
<span class="highlight-line removed">39</span>
<span class="highlight-line removed"><strong>40</strong></span>
<span class="highlight-line removed">41</span>
<span class="highlight-line removed">42</span>
<span class="highlight-line removed">43</span>
<span class="highlight-line removed">44</span>
<span class="highlight-line removed">45</span>
<span class="highlight-line removed">46</span>
<span class="highlight-line removed">47</span>
48
49</pre></td>
  <td class="code"><pre><span class="highlight-line added"><span class="reserved">import</span> Service from <span class="string"><span class="delimiter">'</span><span class="content">@ember/service</span><span class="delimiter">'</span></span>;</span>
<span class="reserved">import</span> { module, test } from <span class="string"><span class="delimiter">'</span><span class="content">qunit</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { setupRenderingTest } from <span class="string"><span class="delimiter">'</span><span class="content">ember-qunit</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { render } from <span class="string"><span class="delimiter">'</span><span class="content">@ember/test-helpers</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> hbs from <span class="string"><span class="delimiter">'</span><span class="content">htmlbars-inline-precompile</span><span class="delimiter">'</span></span>;

<span class="highlight-line added">const StubMapsService = Service.extend({</span>
<span class="highlight-line added">  getMapElement(location) {</span>
<span class="highlight-line added">    <span class="local-variable">this</span>.set(<span class="string"><span class="delimiter">'</span><span class="content">calledWithLocation</span><span class="delimiter">'</span></span>, location);</span>
<span class="highlight-line added">    <span class="comment">// We create a div here to simulate our maps service,</span></span>
<span class="highlight-line added">    <span class="comment">// which will create and then cache the map element</span></span>
<span class="highlight-line added">    <span class="keyword">return</span> document.createElement(<span class="string"><span class="delimiter">'</span><span class="content">div</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">  }</span>
<span class="highlight-line added">});</span>

module(<span class="string"><span class="delimiter">'</span><span class="content">Integration | Component | location map</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(hooks) {
  setupRenderingTest(hooks);

<span class="highlight-line added">  hooks.beforeEach(<span class="keyword">function</span>() {</span>
<span class="highlight-line added">    <span class="local-variable">this</span>.owner.register(<span class="string"><span class="delimiter">'</span><span class="content">service:maps</span><span class="delimiter">'</span></span>, StubMapsService);</span>
<span class="highlight-line added">    <span class="local-variable">this</span>.mapsService = <span class="local-variable">this</span>.owner.lookup(<span class="string"><span class="delimiter">'</span><span class="content">service:maps</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">  });</span>

<span class="highlight-line added">  test(<span class="string"><span class="delimiter">'</span><span class="content">should append map element to container element</span><span class="delimiter">'</span></span>, async <span class="keyword">function</span>(assert) {</span>
<span class="highlight-line added">    <span class="local-variable">this</span>.set(<span class="string"><span class="delimiter">'</span><span class="content">myLocation</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">New York</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">    await render(hbs<span class="error">`</span>{{location-map location=myLocation}}<span class="error">`</span>);</span>
<span class="highlight-line added">    assert.equal(<span class="local-variable">this</span>.element.querySelector(<span class="string"><span class="delimiter">'</span><span class="content">.map-container</span><span class="delimiter">'</span></span>).childNodes.length, <span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">container should have one child</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">    assert.equal(<span class="local-variable">this</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">mapsService.calledWithLocation</span><span class="delimiter">'</span></span>), <span class="string"><span class="delimiter">'</span><span class="content">New York</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">should call service with New York</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">  });</span>

<span class="highlight-line removed">  test(<span class="string"><span class="delimiter">'</span><span class="content">it renders</span><span class="delimiter">'</span></span>, async <span class="keyword">function</span>(assert) {</span>
<span class="highlight-line removed">    <span class="comment">// Set any properties with this.set('myProperty', 'value');</span></span>
<span class="highlight-line removed">    <span class="comment">// Handle any actions with this.set('myAction', function(val) { ... });</span></span>
<span class="highlight-line removed"/>
<span class="highlight-line removed">    await render(hbs<span class="error">`</span>{{rental-listing}}<span class="error">`</span>);</span>
<span class="highlight-line removed"/>
<span class="highlight-line removed">    assert.equal(<span class="local-variable">this</span>.element.textContent.trim(), <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line removed"/>
<span class="highlight-line removed">    <span class="comment">// Template block usage:</span></span>
<span class="highlight-line removed">    await render(hbs<span class="error">`</span></span>
<span class="highlight-line removed">      {{<span class="error">#</span>location-map}}</span>
<span class="highlight-line removed">        template block text</span>
<span class="highlight-line removed">      {{<span class="regexp"><span class="delimiter">/</span><span class="content">location-map}}</span>
<span class="highlight-line removed">    `);</span>
<span class="highlight-line removed"/>
<span class="highlight-line removed">    assert.equal(this.element.textContent.trim(), 'template block text');</span>
<span class="highlight-line removed">  });</span>

});
</span></span></pre></td>
</tr></table>
</div></div>
<p>In the <code>beforeEach</code> function that runs before each test, we use the built-in function <code>this.register</code> to <a href="../../applications/dependency-injection/#toc_factory-registrations">register</a> our stub service in place of the maps service.
Registration makes an object available to your Ember application for things like loading components from templates and injecting services in this case.</p>

<p>The call to the function <code>this.inject.service</code> <a href="../../applications/dependency-injection/#toc_ad-hoc-injections">injects</a> the service we just registered into the context of the tests, so each test may access it through <code>this.get(&#39;mapsService&#39;)</code>.
In the example we assert that <code>calledWithLocation</code> in our stub is set to the location we passed to the component.</p>
<h3 class='anchorable-toc' id='toc_stubbing-services-in-application-tests'>Stubbing Services in Application Tests</h3>
<p>Finally, we want to update our application tests to account for our new service.
While it would be great to verify that a map is displaying, we don&#39;t want to hammer the Google Maps API every time we run our application test.
For this tutorial we&#39;ll rely on our component integration tests to ensure that the map DOM is being attached to our screen.
To avoid hitting our Maps request limit, we&#39;ll stub out our Maps service in our application tests.</p>

<p>Often, services connect to third party APIs that are not desirable to include in automated tests.
To stub these services we simply have to register a stub service that implements the same API, but does not have the dependencies that are problematic for the test suite.</p>

<p>Add the following code to your application test</p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><?xml version="1.0"?>
<table class="CodeRay">
  <thead>
    <tr>
      <td colspan="2">/tests/acceptance/list-rentals-test.js</td>
    </tr>
  </thead>
<tr>
  <td class="line-numbers"><pre><span class="highlight-line added">1</span>
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
<span class="highlight-line added">13</span>
<span class="highlight-line added">14</span>
<span class="highlight-line added">15</span>
<span class="highlight-line added">16</span>
<span class="highlight-line added">17</span>
18
19
<strong>20</strong>
21
22
<span class="highlight-line added">23</span>
<span class="highlight-line added">24</span>
<span class="highlight-line added">25</span>
26
27</pre></td>
  <td class="code"><pre><span class="highlight-line added"><span class="reserved">import</span> Service from <span class="string"><span class="delimiter">'</span><span class="content">@ember/service</span><span class="delimiter">'</span></span>;</span>
<span class="reserved">import</span> { module, test } from <span class="string"><span class="delimiter">'</span><span class="content">qunit</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { setupApplicationTest } from <span class="string"><span class="delimiter">'</span><span class="content">ember-qunit</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> setupMirage from <span class="string"><span class="delimiter">'</span><span class="content">ember-cli-mirage/test-support/setup-mirage</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> {
  click,
  currentURL,
  visit,
  fillIn,
  triggerKeyEvent
} from <span class="string"><span class="delimiter">'</span><span class="content">@ember/test-helpers</span><span class="delimiter">'</span></span>

<span class="highlight-line added">let StubMapsService = Service.extend({</span>
<span class="highlight-line added">  getMapElement() {</span>
<span class="highlight-line added">    <span class="keyword">return</span> document.createElement(<span class="string"><span class="delimiter">'</span><span class="content">div</span><span class="delimiter">'</span></span>);</span>
<span class="highlight-line added">  }</span>
<span class="highlight-line added">});</span>

module(<span class="string"><span class="delimiter">'</span><span class="content">Acceptance | list rentals</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(hooks) {
  setupApplicationTest(hooks);
  setupMirage(hooks);

<span class="highlight-line added">  hooks.beforeEach(<span class="keyword">function</span>() {</span>
<span class="highlight-line added">    <span class="local-variable">this</span>.owner.register(<span class="string"><span class="delimiter">'</span><span class="content">service:maps</span><span class="delimiter">'</span></span>, StubMapsService);</span>
<span class="highlight-line added">  });</span>
  ...
});</pre></td>
</tr></table>
</div></div>
<p>What&#39;s happening here is we are adding our own stub maps service that simply creates an empty div.
Then we are putting it in Ember&#39;s <a href="../../applications/dependency-injection#toc_factory-registrations">registry</a> using the <a href="https://emberjs.com/api/ember/3.0/functions/@ember%2Fapplication/getOwner">owner</a> object given by the test context. When our component loads the maps service, it gets our stub service instead.
That way every time that component is created, our stub map service gets injected over the Google maps service.
Now when we run our application tests, you&#39;ll notice that maps do not get rendered as the test runs.</p>

<p><img src="../../images/service/acceptance-without-maps.png" alt="application tests without maps"></p>



        
      <footer>
        <a href="../autocomplete-component/" class="previous-guide">Building a Complex Component</a> <a href="../subroutes/" class="next-guide">Adding Nested Routes</a>
      </footer>
      
      </article>
    </main>

    <footer class="footer">
  <div class="container">
    <div class="footer-info">
      Copyright 2018
      <a href="http://tilde.io">Tilde Inc.</a>
      <br>
      <a href="http://emberjs.com/team">Team</a> |
      <a href="http://emberjs.com/sponsors">Sponsors</a>
      <br>
      <a href="http://emberjs.com/security">Security</a> |
      <a href="http://emberjs.com/legal">Legal</a> |
      <a href="http://emberjs.com/logos">Logos</a>
      <br>
      <a href="http://emberjs.com/guidelines">Community Guidelines</a>
    </div>

    <div class="footer-statement">
      Ember.js is free, open source and always will be.
      <div class="footer-social">
        <a href="http://twitter.com/emberjs" title="Twitter" aria-label="Ember on Twitter">
          <i class="icon-twitter" aria-hidden="true"></i>
        </a>
        <a href="https://github.com/emberjs/ember.js" title="GitHub" aria-label="Github repository">
          <i class="icon-github" aria-hidden="true"></i>
        </a>
        <a href="https://plus.google.com/communities/106387049790387471205" title="Google+" aria-label="google plus profile">
          <i class="icon-gplus" aria-hidden="true"></i>
        </a>
      </div>
    </div>

    <div class="footer-contributions">
      <div class="contributor">
        <p>Hosted by:</p>
        <a href="https://www.heroku.com/emberjs">
          <img src="https://glimmer-styleguide.global.ssl.fastly.net/glimmer-styleguide/master/images/heroku-logo.svg" class="logo-heroku" alt="heroku">
        </a>
      </div>
      <div class="contributor">
        <p>CDN provided by:</p>
          <a href="https://www.fastly.com">
            <img src="https://glimmer-styleguide.global.ssl.fastly.net/glimmer-styleguide/master/images/fastly-logo.svg" class="logo-fastly" alt="fastly">
          </a>
      </div>
    </div>

  </div>
</footer>


    

    <script type="text/javascript">
      var _gaq = _gaq || [];
      var pluginUrl = '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
      _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
      _gaq.push(['_setAccount', 'UA-27675533-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
